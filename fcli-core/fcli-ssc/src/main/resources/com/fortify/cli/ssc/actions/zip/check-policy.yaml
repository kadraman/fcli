# yaml-language-server: $schema=https://fortify.github.io/fcli/schemas/action/fcli-action-schema-dev-2.x.json

author: Fortify
usage:
  header: (SAMPLE) Check security policy. 
  description: |
    This sample action demonstrates how to implement a security policy using
    fcli actions, returning a non-zero exit code if any of the checks fail.

config:
  rest.target.default: ssc
  
cli.options:
  appversion:
    alias: av
    description: "Required application version id or <appName>:<versionName>"
  
steps:
  - var.set:
      av: ${#ssc.appVersion(cli.appversion)}
      fs: ${#ssc.filterSet(av, cli.filterset)}
  - run.fcli:
    - name: countsByFolder
      args: ssc issue count --av ${av.id} --by FOLDER
  - run.fcli:
    - name: countsByNewIssue
      args: ssc issue count --av ${av.id} --by "New Issue"
  - check:
    - displayName: No critical issues allowed
      failIf:      ${countsByFolder.^[cleanName=='Critical']?.visibleCount>0}
    - displayName: No new issues allowed
      failIf:      ${countsByNewIssue.^[cleanName=='NEW']?.visibleCount>0}
  - run.fcli:
    - args: ssc issue ls --av ${av.id}
      forEach:
        name: issue
        do:
          - check:
            - displayName: No new critical issues allowed
              failIf:      ${issue.scanStatus=='NEW' && issue.friority=='Critical'}
              ifSkipped:   PASS # If no issues
      
