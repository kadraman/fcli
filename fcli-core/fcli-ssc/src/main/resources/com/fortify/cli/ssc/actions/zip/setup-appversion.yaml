# yaml-language-server: $schema=https://fortify.github.io/fcli/schemas/action/fcli-action-schema-dev-2.x.json

author: Fortify
usage:
  header: Set up application version. 
  description: |
      This action allows for preparing an application version for running an application
      security scan, creating the application and/or release if they do not exist yet.
      
      Although the same functionality can be achieved by manually running the 
      `fcli ssc appversion create` command, this action provides a convenient and 
      standardized approach for running this command with some default options like
      `--skip-if-exists` and `--auto-required-attrs`.
      
      To provide even more consistency across CI/CD pipelines in your organization, it
      is recommended to implement one or more custom setup actions that provide suitable
      default values or even hard-coded, non-overridable values for the various options,
      for example based on business unit, team, and/or application type. Such custom 
      actions could for example set standard application version attributes for a 
      particular type of application to be scanned. Alternative to implementing multiple 
      custom actions, you may also consider implementing a single custom action that takes 
      for example a --profile option to select between different profiles that each define 
      appropriate option values and setup commands to run.

config:
  rest.target.default: ssc
  output: immediate
  
cli.options:
  appversion:
    alias: av
    required: true
    description: "Required application version name as <appName>:<versionName>"
  add-users:
    group: av_create_opts
    required: false
    description: "See `fcli ssc appversion create`"
  attrs:
    group: av_create_opts
    required: false
    alias: attributes
    description: "See `fcli ssc appversion create`"
  copy:
    group: av_create_opts
    required: false 
    description: "See `fcli ssc appversion create`"
  description:
    group: av_create_opts
    required: false
    alias: d
    description: "See `fcli ssc appversion create`"
  copy-from:
    group: av_create_opts
    required: false
    alias: from
    description: "See `fcli ssc appversion create`"
  issue-template:
    group: av_create_opts
    required: false
    description: "See `fcli ssc appversion create`"
  refresh-timeout:
    group: av_create_opts
    required: false
    defaultValue: "300s"
    description: "See 'fcli ssc av create'. Default value: 300s"
  
steps:
  - log.progress: "Creating SSC application version if non-existing"
  - run.fcli:
    - name: createAppVersion
      args: ssc av create ${av} --skip-if-exists --auto-required-attrs --refresh ${#action.copyParametersFromGroup("av_create_opts")}
  - file.write:
      - to: stdout
        value: |
          Create application version ${av} (id ${createAppVersion[0].id}): ${createAppVersion[0].__action__}
      
