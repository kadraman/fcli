# yaml-language-server: $schema=https://fortify.github.io/fcli/schemas/action/fcli-action-schema-dev-2.x.json

author: Fortify
usage:
  header: Run CI pipeline
  description: |
    (Work in progress)
    This action can be used to run a full, standardized CI pipeline that performs the
    following activities:
    - Create & configure SSC application version / FoD release if needed
    - Package source code
    - Submit SAST scan request
    - Wait for SAST scan completion
    - Perform post-scan activities, like checking policy outcome, exporting results, ...

config:
  output: immediate
  
steps:
  - var.set:
      run.fod_ci: ${#isNotBlank(#env('FOD_URL'))}
      run.ssc_ci: ${#isNotBlank(#env('SSC_URL'))}
  - if: ${!run.fod_ci && !run.ssc_ci}
    throw: Either FOD_URL or SSC_URL environment variable needs to be set
  - if: ${run.fod_ci && run.ssc_ci}
    throw: Only one of FOD_URL or SSC_URL environment variables may be set
  - run.fcli:
      fod_ci: 
        cmd: ${#actionCmd('FOD_CI', 'fod', 'ci')} --session=from-env
        if: ${run.fod_ci}
      ssc_ci:
        cmd: ${#actionCmd('SSC_CI', 'ssc', 'ci')} --session=from-env 
        if: ${run.ssc_ci}
      
      